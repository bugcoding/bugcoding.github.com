<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="keep coding, keep moving..."><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>C语言的隐式类型提升和java的类型兼容</title><link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">bugcode's note</a></div><div class="about-me">思绪如风，来去匆匆。</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/bugcoding"></span><a href="https://github.com/bugcoding" target="_blank" title="https://github.com/bugcoding">https://github.com/bugcoding</a></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">C语言的隐式类型提升和java的类型兼容</div><span class="date">2014年02月12日</span><span>   </span><span class="tags"><a class="tag-link" href="/tags/C/">C</a></span><div class="content"><p>在java里，x += 1与x = x + 1相同，但是是有一点区别，只不过容易被忽略。如下例：</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCompound</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">short</span> x = <span class="number">1</span>;</span><br><span class="line">        x += <span class="number">1</span>;</span><br><span class="line">        System.out.println(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//此处x打印的值为2；</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCompound2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">short</span> x = <span class="number">1</span>;</span><br><span class="line">        x = x + <span class="number">1</span>;</span><br><span class="line">        System.out.println(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而此处的x = x + 1处就会在编译期报错，因为java编译器认为x + 1是int型的，把int型的赋给short型，类型不兼容，就会报错，要赋值就需要一个强制类型转换，那么在此，二个表达式的区别就看出来了，x += 1，这里暗含了一个自动的类型转换，它会自动把右边的值转换成左边的类型，所以在第一个例子中没有报错，而第二例子中的表达式不会自动转换类型，报错就是必然的了。java的类型转换精度小的向精度大的进行转换，字节长度小的向字节长度大的转换，这里x + 1，x是short类型，x + 1之后编译器认为可能会造成溢出编译器做一个扩宽转换（<strong>widening conversion</strong>），x + 1的结果值直接向int进行类型，结果在赋值的同时发现x是short类型，这里出现了赋值类型不匹配，造成错误的出现。</p>
<p>C语言中也有一个类型转换的规则在，而且在很多的时候容易引起错误的结果，就是隐式类型提升（<strong>TypePromotion</strong>），先看一段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_LEN (sizeof(array) / sizeof(array[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> testValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> promotion = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (promotion &lt;= GET_LEN)</span><br><span class="line">        testValue = <span class="built_in">array</span>[promotion + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        testValue = <span class="built_in">array</span>[promotion + <span class="number">2</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"testValue == %d\n"</span>, testValue);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可能有很多像我这样的菜鸟级选手就会说，输出的是2，也就是if判定是成立的，testValue=array[0]</p>
<p>其实并非如此，promotion &lt;= GET_LEN这个表达式包含一个隐式的类型提升，导致结果是testValue == 3，也就是testValue == array[1];因为sizeof的返回一个size_t类型，也就是unsigned int 类型，也就是GET_LEN宏得到的结果就是unsigned int类型，而表达式的左边promotion是一个int，那么在二者比较的时候，编译器会做一个算术的类型转换，右侧的类型unsigned和而promotion是signed的，有符号的会向无符号的类型转换，那么promotion会提升成unsigned int类型，那么编译器就会把-1解释为一个很大的正整数，也就会有testValue == 3的结果了，想要消除这个错误给GET_LEN一个强制类型转换就可以了。同样的例子还有，看代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str = <span class="string">"12345"</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(str) - <span class="number">10</span> &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"enter forever!\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>strlen的返回值也是size_t类型，像上边所说的相同，if判定中左边的表达式strlen(str) - 10的结果会被隐式提升为size_t类型，也就是不会出小于0的情况，在这种情况也，if判定永远成立，这种情况下要么改成strlen(str) &gt; 10， 要么对表达式做强制类型转换。很多时候这种错误会浪费我们很多时间，所以尽量显式的保持类型一致。</p>
</div></section></div><div class="container"><ul class="nav"><li>上一篇：<a href="/2014/03/31/Makefile初步-1.html">Makefile初步-1</a></li><li>下一篇：<a href="/2014/01/03/写给某鸟的Vim初始配置.html">写给某鸟的Vim初始配置</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><center class="span">2014-2018 bugcode.</center></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>