<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="keep coding, keep moving..."><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Makefile初步-1</title><link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">bugcode's note</a></div><div class="about-me">思绪如风，来去匆匆。</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/bugcoding"></span><a href="https://github.com/bugcoding" target="_blank" title="https://github.com/bugcoding">https://github.com/bugcoding</a></li><li class="social-item"><span class="label"><img src="/images/socials/rss.svg" alt="https://bugcode.net/atom.xml"></span><a href="https://bugcode.net/atom.xml" target="_blank" title="https://bugcode.net/atom.xml">https://bugcode.net/atom.xml</a></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Makefile初步-1</div><span class="date">2014年03月31日</span><span>   </span><span class="tags"><a class="tag-link" href="/tags/Linux/">Linux</a></span><div class="content"><p>在Windows下有诸如vs这样儿“强大”的工具来组织与管理工程，文件层次组织，代码编写，包括选项的设置，编译，链接，都可以在一个窗口中完成（其实背后也是有一个make工具）。Linux下，Unix的哲学，多个不同功能的小工具，组合到一起组成强大的功能，一些小小的文件，我们可以<em>gcc –XXFlags XXOO.c –o XXOO</em>，这样儿来做，但是要是几十个文件，几百个文件呢？还去挨个的输入命令编译？这就是是马上要介绍的make工具，使用make工具，只需要一个命令，就可以构建你的工程。当然，代价就是编写Makefile，make工具就是靠解释Makefile文件来对整个工程进行编译和链接。</p>
<a id="more"></a>
<p>这里先给出一个简单的示例，只为说明用法，简单写了几个文件如下：</p>
<p><strong>utils.c,utils.h,display.c,display.h,main.c</strong>内容如下（非常简单）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _UTILS_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _UTILS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">compute_add</span><span class="params">(<span class="keyword">float</span> a, <span class="keyword">float</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_rand</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">// [utils.c]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"utils.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">compute_add</span><span class="params">(<span class="keyword">float</span> a, <span class="keyword">float</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_rand</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rand() % <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// [display.h]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _DISPLAY_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DISPLAY_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_rand</span><span class="params">(<span class="keyword">int</span> rand)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display_float</span><span class="params">(<span class="keyword">float</span> res)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">// [display.c]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"display.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_rand</span><span class="params">(<span class="keyword">int</span> rand)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"rand number: %d\n"</span>, rand);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display_float</span><span class="params">(<span class="keyword">float</span> res)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"result : %f\n"</span>, res);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// [main.c]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"display.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"utils.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    print_rand(get_rand());</span><br><span class="line">    display_float(compute_add(<span class="number">1.0f</span>, <span class="number">3.0f</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果按最平常的方式，怎么做呢？你肯定想到，先编译utils，display和main为目标文件，再链接三个目标文件，生成main。至少三个命令，有人说了，也不多，那再想，如果我改动了utils文件，那就要再编译utils，再链接main。所以，该Makefile上场了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> makefile <span class="keyword">for</span> sample</span></span><br><span class="line">main: main.c utils.o display.o</span><br><span class="line">    gcc main.c utils.o display.o -o main</span><br><span class="line"> </span><br><span class="line">utils.o: utils.h utils.c</span><br><span class="line">    gcc -c utils.c -o utils.o</span><br><span class="line"> </span><br><span class="line">display.o: display.c display.h</span><br><span class="line">    gcc -c display.c -o display.o</span><br><span class="line"> </span><br><span class="line">.PHONY: clean</span><br><span class="line">clean:</span><br><span class="line">    rm -f *.o main</span><br></pre></td></tr></table></figure>
<p>这就算是一个小小的Makefile了，慢慢看一下它。</p>
<ol>
<li>首先，#号开头，Makefile的注释，作用从行首到行尾，如果想换行，需要加上\转义换行。</li>
<li>接下来有三个名称然后跟冒号，这三个名称（或者叫文件名）叫做目标，就是要生成的东西，无论是生成的中间文件，还是最终文件，都叫做目标，通常放在第一个位置的都是最终要生成的目标，如本例是main。</li>
<li>之后冒号后跟了几个空格分隔的名称（文件名），这叫做依赖，看名字就是知道，意思就是目标文件要生成，那么就依赖这几个文件，也就是生成这个目标的必要文件，没有先后顺序。</li>
<li>然后，每个目标和依赖的下一行都有一行命令，这个命令就是上面的依赖，通过下面的命令生成目标，需要注意的是，命令需要以Tab开头，不然make不会识别，如果Makefile某个部分过长，可以通过\来转到下一行继续。</li>
</ol>
<p>根据上面几个部分的具体规则，就可以在本目录下通过make命令构建出最终目标了，默认是生成第一个目标文件，想只生成其中的某个目标，可以使用make obj类似的命令，如本例，如只想生成utils.o文件，则可以用make utils.o命令。每次的构建生成，make工具都会检测每个对应的文件是否是最新生成的，如果某个文件不是最新生的，那么make将重新构建对应的目标，如果某个目标的依赖是这个重新构建的目标，那么同样儿的，这个目标也会被重建。make的工作方式就是解释Makefile，以现第一个目标，然后去寻找它的依赖，如果依赖存在，就寻找下一个依赖，如果这个依赖不存在，就去找对应的依赖的作为目标的构建规则，直到生成这个依赖，有点儿像C语言里面的递归。层层下去，然后最终文件都齐全了，生成最终目标。</p>
<p>再看这个小Makefile的最后三行，.PHONY:XXX指示其冒号后的这个目标是伪目标，也就是防止在make XXX的时候，当前目录下正好有一个叫做XXX的文件，那么make就会现错误或者停止工作了。声明这个伪目标，make XXX的时候，就不会出现上述状况了，而这个例子中clean下面的命令，就是清除生成的文件（包括是中间文件和最终目标，像一般IDE里的清理生成，清理解决方案之类的。），make clean之后，生成的是中间和最终文件就全被删除了，再次make，就是重新构建了。</p>
<p>感兴趣的也可以自己组织一个小“工程”，练习一下Makefile的初级使用。</p>
</div></section></div><div class="container"><ul class="nav"><li>上一篇：<a href="/2014/04/03/Makefile初步-2.html">Makefile初步-2</a></li><li>下一篇：<a href="/2014/02/12/C语言的隐式类型提升和java的类型兼容.html">C语言的隐式类型提升和java的类型兼容</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><center class="span">2014-2018 bugcode.</center></div></footer><script src="/script/jquery.min.js"></script><script src="/script/index.js"></script><script src="/script/jquery.min.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>