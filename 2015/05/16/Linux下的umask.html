<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="keep coding, keep moving..."><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Linux下的umask</title><link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">bugcode's note</a></div><div class="about-me">思绪如风，来去匆匆。</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/bugcoding"></span><a href="https://github.com/bugcoding" target="_blank" title="https://github.com/bugcoding">https://github.com/bugcoding</a></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Linux下的umask</div><span class="date">2015年05月16日</span><span>   </span><span class="tags"><a class="tag-link" href="/tags/Linux/">Linux</a></span><div class="content"><p>​        偶然看到一本书上写umask(掩码)的计算，说是用户的实际文件(夹)权限是通过默认文件(夹)权限与掩码相减得到的。感觉不太对。</p>
<a id="more"></a>
<p>​        先说掩码，Linux下的文件有三个权限“段”，一个文件所有者的权限，一个同用户组的权限，一个是其他用户的权限，三个“段”又分了三个部分，可读，可写，可执行，每个部分用一个八进制数表示，那么权限也就可以表示成000à777之间的数字（例如421，就表示文件拥有者有读权限，同用户组的有写权限，其他用户有执行权限）。而Linux针对文件和文件夹又有一个默认的原始权限，文件的是666，也就是三个不同有用户都有读写权限没有执行权限，文件夹是777，也就是三个不同的用户拥有所有的权限，而掩码，就是对文件（夹）默认权限的“遮掩”，通过对umask的设置，对文件（夹）重新设置了权限。使用umask命令可以查看用户当前的掩码。具体参考man umask。<br>​        而通过掩码又是怎么算得到对应的权限呢，比如大多用户的掩码都是0002，那通过这个掩码和文件（夹）默认权限如何得到最终文件的权限，很多书上都说是默认权限减去掩码，或者默认权限与掩码作异或，再或者就是对掩码取反，也就是从默认权限上“抽离”对应的“段”里面的位。像上面所说，掩码0002，文件默认权限0666，第一种，相减，结果当然是0664，正确了，第二种，异或，结果0664，也正确了，第三种，对0002的二进制取反，结果也是0664，也正确了。好像都是对的，但是假如，是说假如，把对应的0002改成0033，那么这几种还能正确吗？<br>其实所有的上面的说法都是在二个前提下的，也就是掩码的“遮掩”的规则：</p>
<blockquote>
<p>Linux下文件的默认权限都是0666，也就是都没有执行权限。</p>
<p>Linux下的文件夹的默认权限是0777，也就是都有执行权限。</p>
</blockquote>
<p>​        在这二个前提下，上面的无论是异或，取反，都要考虑到文件的特殊性就是没有可执行权限，一旦出现一个像0033这样的“奇葩”掩码，就要考虑到文件的默认权限里没有可执行权限，就是三个位中的421中的1是没有的，知道了这个，那0033，也就相当于0022了，因为对应的可执行权限是本来就没有的。可以像下边这样试一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> <span class="built_in">umask</span> 033</span></span><br><span class="line"><span class="meta">%</span><span class="bash"> touch <span class="built_in">test</span></span></span><br><span class="line"><span class="meta">%</span><span class="bash"> ls –al <span class="built_in">test</span></span></span><br></pre></td></tr></table></figure>
<p>应该可以看到对应的文件权限还是-rwxr–r–，也就是644。</p>
<p>​        Linux下还有一个umask的函数，通过umask函数设置文件掩码，此时文件的权限就是由创建文件的函数来指定了（也就是说文件的权限不是666了，而是由创建文件函数来指定的）。下机是一个简单的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">         <span class="keyword">int</span> permission = <span class="number">00777</span>;</span><br><span class="line">         umask(<span class="number">0000</span>);<span class="comment">//相当于没有设置掩码</span></span><br><span class="line">         <span class="keyword">if</span> (creat(<span class="string">"test_file"</span>, permission) &lt; <span class="number">0</span>)<span class="comment">//创建一个文件,以查看权限</span></span><br><span class="line">         &#123;</span><br><span class="line">                   <span class="built_in">printf</span>(<span class="string">"Create File Error!\n"</span>);</span><br><span class="line">                   <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">int</span> mask = <span class="number">0033</span>;</span><br><span class="line">         umask(mask);<span class="comment">//设置文件权限掩码</span></span><br><span class="line">         <span class="keyword">if</span> (creat(<span class="string">"test_mask_file"</span>, permission) &lt; <span class="number">0</span>)<span class="comment">//掩码作用于同用户组和其他的写和执行权限</span></span><br><span class="line">         &#123;</span><br><span class="line">                   <span class="built_in">printf</span>(<span class="string">"Create File Error!\n"</span>);</span><br><span class="line">                   <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">         &#125;</span><br><span class="line">        </span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>% gcc –Wall –std=c99 test_umask.c –o test_umask</p>
</blockquote>
<p>执行后产生二个文件，详细如下（centOS编译）：</p>
<p><img src="/chapimages/image001.png" alt=""></p>
<p>也就是没有设置掩码的文件权限是777，设置了033掩码的文件权限是755，有人说不对啊，掩码是033，原来的是777，最终的应该是744啊，没错，这里的确有点儿小问题，问题就在creat函数上，creat函数在生成文件的时候只取与读和写相关的参数，也就是没有与执行相关的参数，到这里就又回来上面去了，也就是掩码其实就是0022，总结出来就是，掩码如果含有奇数，要么直接计算，然后在结果的奇数对应位上各加上1，或者，直接参与运算的时候把掩码位中含有奇数的位直接减去1。这样也就是最终的777 与 022 ，生成的最终的文件权限就是755。</p>
<p>​        综上，与文件相关，掩码含有奇数，直接在奇数位减去1，再计算，如果为偶数，就直接算出权限。</p>
</div></section></div><div class="container"><ul class="nav"><li>上一篇：<a href="/2015/06/05/C和C-与Java的互相调用.html">C和C++与Java的互相调用</a></li><li>下一篇：<a href="/2015/04/19/使用SIGCHLD信号异步清理子进程.html">使用SIGCHLD信号异步清理子进程</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><center class="span">2014-2018 bugcode.</center></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>