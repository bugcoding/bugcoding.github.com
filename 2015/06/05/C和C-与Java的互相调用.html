<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="keep coding, keep moving..."><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>C和C++与Java的互相调用</title><link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">bugcode's note</a></div><div class="about-me">keep coding, keep moving...</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/bugcoding"></span><a href="https://github.com/bugcoding" target="_blank" title="https://github.com/bugcoding">https://github.com/bugcoding</a></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">C和C++与Java的互相调用</div><span class="date">2015年06月05日</span><span>   </span><span class="tags"><a class="tag-link" href="/tags/C/">C++</a><a class="tag-link" href="/tags/Java/">Java</a></span><div class="content"><p>因为adnroid项目中用到了获取mac地址做为唯一码的功能，c和c++在android却没有对应的api，还好有jni这个东西，用java写好获取mac地址的代码，用c/c++调用代码就可以直接获取mac字符串了。</p>
<a id="more"></a>
<p>JNI(Java Native Interface)Java本地接口，详情点击<a href="http://en.wikipedia.org/wiki/Java_Native_Interface" target="_blank" rel="noopener">此处</a>，就是java用来与本地的已经编译的语言交互的接口。这里使用的环境是<strong>windows 7 64，gcc 4.6.2，jdk 1.6</strong>。</p>
<p>首先看在Java中调用c/c++:</p>
<ol>
<li><p>创建Java类（JavaJni），创建要交互的本地方法，使用native关键字，加载我们要调用的动态库。</p>
</li>
<li><p>编译创建的Java类，无错生成.class文件。</p>
</li>
<li><p>通过JDK中javah工具生成本地方法声明的头文件。（这里没有使用包名，正确方法是javah 包名.类名）</p>
</li>
<li><p>生成本地声明的头文件之后，编写对应的c或者c++文件，实现具体的本地方法。</p>
</li>
<li><p>编译生成动态链接库，windows下是dll文件，linux是so文件。这里是使用windows下的MinGW编译生成dll文件。（因为windows下jni的默认是使用vc的调用约定， 所以这步使用gcc生成dll文件时候需要注意不同平台调用约定的实现，下文会说）。</p>
</li>
<li><p>生成动态库后，将其放入java.library.path所指定的路径中，可能通过getProperty方法查看java.library.path所在的路径，将其放入任意一个即可加载。</p>
</li>
<li><p>执行java JavaJni，查看结果。</p>
<p>下面写一个测试，具体实现一下上面的步骤：</p>
<p>a. 创建Java类（JavaJni）如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaJni</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String [] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        JavaJni jni = <span class="keyword">new</span> JavaJni();</span><br><span class="line">        <span class="comment">//本地方法测试</span></span><br><span class="line">        jni.jniVoidTest();</span><br><span class="line">        System.out.println(<span class="string">"==============================="</span>);</span><br><span class="line">        System.out.println(jni.jniStringTest());</span><br><span class="line">        System.out.println(<span class="string">"==============================="</span>);</span><br><span class="line">        System.out.println(jni.jniIntTest());</span><br><span class="line">        System.out.println(<span class="string">"==============================="</span>);</span><br><span class="line">        System.out.println(jni.jniWithString(<span class="string">"From JavaJni"</span>));</span><br><span class="line">        System.out.println(<span class="string">"==============================="</span>);</span><br><span class="line">        <span class="keyword">int</span>[] array = jni.jniArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(array[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"==============================="</span>);</span><br><span class="line">        <span class="keyword">int</span>[] temp = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line">        System.out.println(jni.jniWithArray(temp, temp.length));</span><br><span class="line">        System.out.println(<span class="string">"==============================="</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//类初始化时候加载动态库</span></span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"JavaJni"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//本地方法声明 使用native关键字</span></span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">void</span> <span class="title">jniVoidTest</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">native</span> String <span class="title">jniStringTest</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">jniIntTest</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">native</span> String <span class="title">jniWithString</span><span class="params">(String str)</span></span>;</span><br><span class="line">    <span class="keyword">native</span> <span class="keyword">int</span>[] jniArray();</span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">jniWithArray</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span> len)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>native关键字声明本地dll中要调用的方法，静态块在类初始化的时候加载动态库。主方法中调用本地方法做一个简单的测试，六个不同的返回值，不同参数的测试方法。</p>
<p>b.编译创建的Java类：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac JavaJni.java</span><br></pre></td></tr></table></figure>
<p>c. 通过javah工具生成本地方法声明的头文件，由于这里没有指定包名，直接使用类名:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javah JavaJni(注意这里是JavaJni，没有后缀)</span><br></pre></td></tr></table></figure>
<p>这里会生成一个JavaJni.h的本地方法的头文件声明，类似如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class JavaJni */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_JavaJni</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_JavaJni</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Class:     JavaJni</span></span><br><span class="line"><span class="comment">* Method:    jniVoidTest</span></span><br><span class="line"><span class="comment">* Signature: ()V</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_JavaJni_jniVoidTest</span><br><span class="line"> (JNIEnv *, jobject);</span><br></pre></td></tr></table></figure>
<p>#ifdef __cplusplus<br>}<br>#endif<br>#endif</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">d. 如注释所说，这是机器生成的方法声明，直接使用即可。现在要对应头文件创建JavaJni.c文件实现每个声明的本地方法，这里做简单的实现：</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;assert.h&gt;</span><br><span class="line">#include &quot;JavaJni.h&quot;</span><br><span class="line"> </span><br><span class="line">#define BUFF_SIZE 5</span><br><span class="line"> </span><br><span class="line">JNIEXPORT void JNICALL Java_JavaJni_jniVoidTest(JNIEnv *env, jobject obj)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;&gt;&gt;: Excute [jniVoidTest] success\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jstring JNICALL Java_JavaJni_jniStringTest(JNIEnv *env, jobject obj)</span><br><span class="line">&#123;</span><br><span class="line">    char *static_str = &quot;excute [jniStringTest] success\n&quot;;</span><br><span class="line">    //创建可供返回的jstring</span><br><span class="line">    jstring jstr = (*env)-&gt;NewStringUTF(env, static_str);</span><br><span class="line">    return jstr;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jint JNICALL Java_JavaJni_jniIntTest(JNIEnv *env, jobject obj)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;excute [jniIntTest] success\n&quot;);</span><br><span class="line">    return 1024;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jstring JNICALL Java_JavaJni_jniWithString(JNIEnv *env, jobject obj, jstring str)</span><br><span class="line">&#123;</span><br><span class="line">    const char *temp = NULL;</span><br><span class="line">    //由传入的参数获取c类型的字符串</span><br><span class="line">    temp = (*env)-&gt;GetStringUTFChars(env, str, 0);</span><br><span class="line">    //只做测试，简单的写一个断言，其他的要做对应的参数为空处理</span><br><span class="line">    assert(temp);</span><br><span class="line">    printf(temp);</span><br><span class="line">    //减引用计数</span><br><span class="line">    (*env)-&gt;ReleaseStringUTFChars(env, str, temp);</span><br><span class="line">    char *r_str = &quot;excute [jniWithString] success\n&quot;;</span><br><span class="line"> </span><br><span class="line">    jstring jstr = (*env)-&gt;NewStringUTF(env, r_str);</span><br><span class="line">    return jstr;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jintArray JNICALL Java_JavaJni_jniArray(JNIEnv *env, jobject obj)</span><br><span class="line">&#123;</span><br><span class="line">    jint tmp_buffer[BUFF_SIZE] = &#123;0&#125;;</span><br><span class="line">    for (int i = 0; i &lt; BUFF_SIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        tmp_buffer[i] = i + 4;</span><br><span class="line">    &#125;</span><br><span class="line">    jintArray int_array = (*env)-&gt;NewIntArray(env, BUFF_SIZE);</span><br><span class="line">    //将数所设设置到将要返回给java端的数组中去</span><br><span class="line">    (*env)-&gt;SetIntArrayRegion(env, int_array, 0, BUFF_SIZE, tmp_buffer);</span><br><span class="line">    return int_array;</span><br><span class="line">&#125;</span><br><span class="line">JNIEXPORT jboolean JNICALL Java_JavaJni_jniWithArray(JNIEnv *env, jobject obj, jintArray array, jint len)</span><br><span class="line">&#123;</span><br><span class="line">   //此处使用从java处copy数组数据到此，不对java处的数据做修改</span><br><span class="line">   jint tmp_array[len];</span><br><span class="line">   //由java处的数组获取数组数据，之后不要忘记减少引用计数</span><br><span class="line">   (*env)-&gt;GetIntArrayRegion(env, array, 0, len, tmp_array);</span><br><span class="line"> </span><br><span class="line">   for (int i = 0; i &lt; len; i++)</span><br><span class="line">   &#123;</span><br><span class="line">       printf(&quot;%d\t&quot;, tmp_array[i]);</span><br><span class="line">   &#125;</span><br><span class="line">   printf(&quot;\n&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键部分都做了注释，注意的地方就是：NewStringXXX之后不要忘记ReleaseString减少对应的引用计数以防止内存泄露。</p>
<p>e. 编译上一步所写的实现文件生成动态库，这里环境是windows，所以使用gcc生成dll文件。</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wl, --kill-at -std=c99 -shared -o JavaJni.dll JavaJni.c</span><br></pre></td></tr></table></figure>
<p>   参数一个一个看：</p>
<p>   <strong>-std=c99</strong> 这里是使用C语言的c99标准，包括for循环的初始化部分变量声明和变长数组。</p>
<p>   <strong>-shared</strong> 链接器选项，用于生成一个共享库目标文件。也就是生成这个动态库的选项。</p>
<p>   <strong>-o</strong> 指定输出（地球人都知道）</p>
<p>   <strong>-Wl</strong>, 这个选项是把这个后面的选项传递给链接器。后面的–kill-at才是真正起作用的。</p>
<p>   由于JNI加载dll的中导出的函数名在windows下是与MSVC相同的。而JNI的调用约定使用的是<em>__stdcall</em>，gcc下生成的dll导出的函数名是<em>func_name@shift_value</em>的形式。MSVC下生成的dll导出的函数名是<em>func_name</em>，这里出现了差异，那么JNI在使用gcc生成的dll的时候就会出现找不到对应的函数名的错误，链接错误，是因为导出的函数名不同的原因。所以才会使用Wl, <strong>–kill-at</strong>给链接器的选项，使生成的dll导出的函数名是<em>func_name</em>这种形式，<strong>kill-at</strong>的意思也就是去掉@之后的部分。[这里如有说得不对，请指正，非常感激！]这里是一个不同的调用约定，在不同编译器下导出函数名：</p>
<p>   <img src="/chapimages/func_name.png" alt=""></p>
<p>   还可以使用另一个链接器的选项，<strong>-Wl</strong>,<strong>–add-stdcall-alias</strong>即同时导出<em>func_name@shift_value</em>和<em>func_name</em>二种函数名的。</p>
<p>   这里生成动态库的时候可能还会出现jni.h找不到的情况，在MinGW下最简单的方法就是把JDK目录下的include下的所有文件都拷贝到MinGW的include目录中（包括win32目录下的头文件都复制到MinGW下的include文件夹中）。这样gcc就可以找到jni.h了。</p>
<p>   f. 生成dll之后加入java.library.path中，如果不知道具体的目录在哪，可以放到system32，或者自己看一下java.library.path，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutJavaPath</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String [] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String path = System.getProperty(<span class="string">"java.library.path"</span>);</span><br><span class="line">        System.out.println(path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>   得到path的值之后，把dll放到合适的目录。</p>
<p>   g. 执行JavaJni(java JavaJni)。到这里就会看到console里的输出。如下：</p>
<p>   <img src="/chapimages/result.png" alt=""></p>
<p>   到这里就是使用Java本地接口JNI调用本地语言实现的实现的整个过程。</p>
</div></section></div><div class="container"><ul class="nav"><li>上一篇：<a href="/2015/06/15/C和C-与Java互相调用-续.html">C和C++与Java互相调用(续)</a></li><li>下一篇：<a href="/2015/05/16/Linux下的umask.html">Linux下的umask</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><center class="span">2014-2018 bugcode.</center></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>