<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="keep coding, keep moving..."><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>几个用到不多却很有用的C语言特性和小Tricky</title><link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">bugcode's note</a></div><div class="about-me">思绪如风，来去匆匆。</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/bugcoding"></span><a href="https://github.com/bugcoding" target="_blank" title="https://github.com/bugcoding">https://github.com/bugcoding</a></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">几个用到不多却很有用的C语言特性和小Tricky</div><span class="date">2016年09月17日</span><span>   </span><span class="tags"><a class="tag-link" href="/tags/C/">C</a></span><div class="content"><p>几个C语言的特性和tricky，平时不常用到，却很有用，这里记录一下。</p>
<a id="more"></a>
<ol>
<li><p>数组传参时的<strong>static</strong>修饰，编译期检查数据长度，类似<code>void test_static(char param[static 5])</code>，意思就是传入的param的char类型数组参数至少要有五个元素。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// char param[static 1]检测NULL</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_static</span><span class="params">(<span class="keyword">char</span> param[<span class="keyword">static</span> <span class="number">5</span>])</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// code here</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> x[<span class="number">3</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line">    test_static(x);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述写法就会出现如下警告:</p>
<blockquote>
<p>warning: array argument is too small; contains 3 elements, callee requires at least 5 [-Warray-bounds]</p>
</blockquote>
<p>可参考<a href="http://stackoverflow.com/questions/30453010/what-is-the-meaning-of-static-in-parameters-array-types-in-c" target="_blank" rel="noopener">这里</a>。</p>
</li>
<li><p>动态指定printf输出数据的长度。可以用这种方式指定浮点数小数部分的保留位数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pre = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">float</span> num = <span class="number">1.2432</span>;</span><br><span class="line">    <span class="keyword">char</span> *str = <span class="string">"test statements"</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"num = %.*f\n"</span>, pre, num); <span class="comment">// 输出 1.234</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"str = %.*s\n"</span>, pre, str); <span class="comment">// 输出 tes</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>printf还有一个格式参数<strong>%n</strong>，这个参数不输出任何内容，但是会把<strong>%n</strong>所在位置之前的字符计数都放入一个整型数值中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pre = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> out_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *str = <span class="string">"test statements"</span>;</span><br><span class="line">    <span class="comment">// 回车之前的字符计数都会放在out_num中</span></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="built_in">printf</span>(<span class="string">"str = %.*s%n\n"</span>, pre, str, &amp;out_num); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"out_num=%d, ret = %d\n"</span>, out_num, ret); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出:</p>
<blockquote>
<p>str = test<br>out_num=10, ret = 11</p>
</blockquote>
</li>
<li><p>c11添加了<strong>_Static_assert</strong>静态断言，在c11之前可以自行定义一个『静态断言』，即条件为假制造编译错误。(from stackoverflow)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STATIC_ASSERT(COND,MSG) typedef char static_assertion_##MSG[(!!(COND))*2-1]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILE_TIME_ASSERT3(X,L) STATIC_ASSERT(X,static_assertion_at_line_##L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILE_TIME_ASSERT2(X,L) COMPILE_TIME_ASSERT3(X,L)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMPILE_TIME_ASSERT(X)    COMPILE_TIME_ASSERT2(X,__LINE__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    COMPILE_TIME_ASSERT(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)==<span class="number">5</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译提示如下:</p>
<blockquote>
<p>error: ‘static_assertion_static_assertion_at_line_11’ declared as an array with a negative size</p>
<p>COMPILE_TIME_ASSERT(sizeof(int) == 3);</p>
</blockquote>
</li>
<li><p>编译器的尝试性定义，代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">10</span>; <span class="comment">// 或者int i;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码不会报错，C标准是这样来解释的，因为声明是出现在文件域的，不是出现在某个函数域内，把其当做外部定义，同时编译器还根据定义是否有初始值来区分，带初值的就叫做定义，没有初始值的也没extern关键的字就是尝试性的定义，如果文件中同时出现了这二种(也就是一个是定义，一个是尝试性定义，像上文代码)，这样那个没有带初始值的就直接当做冗余定义来处理了，不会当做redefinition，如果二个都是没带初值的，也没带extern关键字的，编译器就会把这二个尝试性定义合并成为一个初始值为0的非尝试性定义。现在上面的代码会输出10，如果把<code>int i = 10</code>改为<code>int i;</code>，代码会输出0。</p>
</li>
<li><p>不能在一个返回类型为void的函数中写return void，但是可以返回执行一个返回void的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> foo(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>网上很多例子说三元运算符可以这样用:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> y = <span class="number">0</span>;</span><br><span class="line">    (y &lt; <span class="number">0</span> ? x : y) = <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, x, y);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说三元运算符会产生一个左值，c语言里面是不可以的，这样编译:</p>
<blockquote>
<p>gcc -Wall -std=c99 test.c -o test</p>
</blockquote>
<p>会报编译错误，提示你表达式不能被赋值(<em>error: expression is not assignable</em>)。</p>
<p>但是在c++里的确可以。也就是上面这段代码用g++编译(会有警告)或者直接写一段c++的代码:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> y = <span class="number">0</span>;</span><br><span class="line">    (y &lt; <span class="number">0</span> ? x : y) = <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d %d\n"</span>, x, y);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>g++ -Wall test.cpp -o test</p>
<p>./test </p>
</blockquote>
<p>会输出10 20。</p>
</li>
</ol>
</div></section></div><div class="container"><ul class="nav"><li>上一篇：<a href="/2016/10/22/Git小记.html">Git小记(基础命令)</a></li><li>下一篇：<a href="/2016/09/10/Xcode-8使用XVim的问题.html">Xcode-8使用XVim的问题</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><center class="span">2014-2018 bugcode.</center></div></footer><script src="/script/jquery.min.js"></script><script src="/script/index.js"></script><script src="/script/jquery.min.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>