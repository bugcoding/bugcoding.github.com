<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content="keep coding, keep moving..."><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>五读《Expert C Programming》</title><link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">bugcode's note</a></div><div class="about-me">keep coding, keep moving...</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/bugcoding"></span><a href="https://github.com/bugcoding" target="_blank" title="https://github.com/bugcoding">https://github.com/bugcoding</a></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">五读《Expert C Programming》</div><span class="date">2017年03月05日</span><span>   </span><span class="tags"><a class="tag-link" href="/tags/C/">C</a></span><div class="content"><p>闲着没事儿在书架上找书看，又看到了翻得有些旧的《C专家编程》拿起来又翻了一遍，大二买的书，前后看了四遍，这是第五遍，每次看看都能有一点儿新的收获。</p>
<a id="more"></a>
<h5 id="pragma"><a href="#pragma" class="headerlink" title="#pragma"></a>#pragma</h5><p>是来源来Ada语言的一个编译器指示符，#pragma是由编译器来指定的具体效果，书上记录了一个很意思的关于GNU C 1.3.4版本编译器#pragma指示符的效果:</p>
<blockquote>
<p>GNU C 1.3.4编译器在遇到#pragma指示符的时候，首先会尝试运行”hack”游戏，如果失败，会再尝试运行”Rogue”游戏，如果还失败，就继续尝试打开Emacs编辑器并运行”汉诺塔”游戏，最后再失败，编译器才报错。</p>
<p>「Rogue」: Unix上的迷宫探索游戏，具体可参见此<a href="https://zh.wikipedia.org/wiki/Rogue" target="_blank" rel="noopener">Wiki</a></p>
<p>「Hack」: 地牢探索游戏，具体参见<a href="https://en.wikipedia.org/wiki/Hack_%28video_game%29" target="_blank" rel="noopener">Wiki</a></p>
</blockquote>
<p>几个经常用的#pragma</p>
<ol>
<li><p>编译时打印消息 <code>#pragma message(&quot;compile message&quot;)</code></p>
</li>
<li><p>屏蔽特定编译警告 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic ignored <span class="meta-string">"具体的警告字符串"</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>微软系的msvc使用方法和GCC的不同</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span>  <span class="meta-keyword">warning</span>( push ) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span>  <span class="meta-keyword">warning</span>( disable: 具体的警告代码数字 ) <span class="comment">// 可以写多个警告的代码</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置内存对齐 #pragma pack(内存对齐值)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span>  pack(push 4) <span class="comment">// 设置4个字节内存对齐</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>gcc的pragma文档可以在<a href="https://gcc.gnu.org/onlinedocs/gcc-5.4.0/gcc/Pragmas.html" target="_blank" rel="noopener">这里</a>找到。</p>
</li>
</ol>
<h5 id="NUL与NULL"><a href="#NUL与NULL" class="headerlink" title="NUL与NULL"></a>NUL与NULL</h5><p>平时用习惯了，真正说一下二个的区别可能并不能说得特别清楚。</p>
<p><code>NUL</code>表示ASCII码结束的字符，即是<code>&#39;\0&#39;</code>的字符名字，就是空字符的意思，但是不要误认为这是C的的一个宏定义，这样写是<strong><em>不正确</em></strong>的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> str[<span class="number">8</span>] = <span class="string">"Hello"</span>;</span><br><span class="line">    str[<span class="number">5</span>] = NUL; <span class="comment">// 并没有预定义的一个叫NUL的宏</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, str);</span><br><span class="line">    <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>NULL</code>表示0，内存的0位置(内存地址较低的位置都是操作系统预留的)，表示空指针，即指针没有指向任何内容，指针初始化为空的时候都使用<code>NULL</code>赋值。</p>
<h5 id="setjmp-longjmp"><a href="#setjmp-longjmp" class="headerlink" title="setjmp longjmp"></a>setjmp longjmp</h5><p>C语言中比<code>goto</code>更强大的改变控制流的机制，平常很少用，经常忘记用法。</p>
<p><code>setjmp(jmp_buf j)</code>是一个宏，调用处就是标记当前的调用环境的上下文，保存当前的调用堆栈，用来调用<code>longjmp</code>的时候将控制流返回到这里再次执行，第一次调用<code>setjmp</code>时一定返回0。</p>
<p><code>longjmp(jmp_buf j, int return_value)</code>这里的j就是<code>setjmp</code>时设置<code>jmp_buf</code>(保证jmp_buf不变)，<code>return_value</code>就是指定控制流返回<code>setjmp</code>时，<code>setjmp</code>再调用一遍时返回的值。</p>
<p>这个强大控制流转移机制，可以实现C语言的异常处理，看个简单的例子:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jmp_buf context;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">memory_handler</span><span class="params">(<span class="keyword">void</span> *mem_pointer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mem_pointer)</span><br><span class="line">    &#123;</span><br><span class="line">        longjmp(context, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// other logic ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *pointer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> rval = setjmp(context);</span><br><span class="line">    <span class="keyword">if</span> (rval)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"return value %d\n"</span>, rval);</span><br><span class="line">        <span class="keyword">switch</span> (rval)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"nullpointerexception check memory alloc\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// ... other handler</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        memory_handler(pointer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>memory_handler</code>发现pointer是空指针之后重新将控制流程移回<code>setjmp</code>带着新的返回值1，然后就进入第一个分支对应的处理语句，最终输出<code>nullpointerexception check memory alloc</code>。</p>
<p><code>goto</code>语句只能在同一个函数中跳转到一个指定标签处的代码，而<code>longjmp</code>可以跨越函数跳转，是C中一个强大的机制。</p>
<p>使用<code>setjmp</code>时需要注意一点，如果<code>setjmp</code>不在<code>main</code>函数中调用而是在其他自定义函数中调用，那一旦这个自定义调用的函数返回，对应记录的调用上下文环境的<code>jmp_buf</code>也就失效了，longjmp再调用时，就回不到<code>jmp_buf</code>记录的控制流处了，像下面这个例子，代码不会有任何输出:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> jmp_buf context;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">longjmp_exp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    longjmp(context, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setjmp_within_func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setjmp(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rval = setjmp_within_func();</span><br><span class="line">    <span class="keyword">if</span> (rval)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"return value %d\n"</span>, rval);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        longjmp_exp();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></section></div><div class="container"><ul class="nav"><li>上一篇：<a href="/2017/03/15/《IT简史》速读.html">《IT简史》速读</a></li><li>下一篇：<a href="/2017/02/10/关于URL编码.html">关于URL编码</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><center class="span">2014-2018 bugcode.</center></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script src="/script/post.js"></script></body></html>